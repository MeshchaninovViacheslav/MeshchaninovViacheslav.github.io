<!--
  Jekyll Pure Liquid Table of Contents
  (c) 2017-2022, Allejo, license: MIT
-->
{%- comment -%}
  Table of Contents
  =================
  (inspired by https://github.com/ghiculescu/jekyll-table-of-contents)

  When the `html` parameter is passed, the ToC will be generated based on the
  HTML of that variable. When it is not passed, the ToC will be generated based
  on the current page's content.

  Parameters:
  * html (string)
    - The HTML to parse headings from.
    - Defaults to: `content`
  * sanitize (boolean)
    - When set to true, the headers will be stripped of any HTML in the ToC.
    - Defaults to: `false`
  * class (string)
    - A CSS class assigned to the ToC.
    - Defaults to: `""`
  * id (string)
    - An ID to be assigned to the ToC.
    - Defaults to: `""`
  * h_min (int)
    - The minimum TOC header level to use; any heading lower than this value will be ignored.
    - Defaults to: `1`
  * h_max (int)
    - The maximum TOC header level to use; any heading greater than this value will be ignored.
    - Defaults to: `6`
  * ordered (boolean)
    - When set to true, an ordered list will be outputted instead of an unordered list.
    - Defaults to: `false`
  * item_class (string)
    - Add custom class for each list item.
    - Has support for `%level%` placeholder, which is the current heading level.
    - Defaults to: `""`
  * submenu_class (string)
    - Add custom class(es) for each child group of headings.
    - Has support for `%level%` placeholder which is the current "submenu" heading level.
    - Defaults to: `""`
  * base_url (string)
    - Add a base url to the ToC links for when your ToC is on another page than the actual content.
    - Defaults to: `""`
  * anchor_class (string)
    - Add custom class(es) for each anchor element.
    - Defaults to: `""`
  * skip_no_ids (boolean)
    - Skip headers that do not have an id attribute.
    - Defaults to: `false`
  * flat_toc (boolean)
    - When set to true, the ToC will be a single level list.
    - Defaults to: `false`
{%- endcomment -%}

{%- if page.toc != false and content contains "<h" -%}
    {%- comment -%}
        The headline buffer is stored in a string, and is manipulated using split and join.
        This is because Liquid arrays are ridiculously slow.
    {%- endcomment -%}

    {%- assign headline_buffer = " " -%}
    {%- assign headline_last_level = 0 -%}
    {%- assign headline_words = "" -%}

    {%- assign list_type = "ul" -%}
    {%- if include.ordered == true -%}
        {%- assign list_type = "ol" -%}
    {%- endif -%}

    {%- if include.item_class -%}
        {%- assign item_class = include.item_class | prepend: ' class="' | append: '"' -%}
    {%- else -%}
        {%- assign item_class = "" -%}
    {%- endif -%}

    {%- if include.submenu_class -%}
        {%- assign submenu_class = include.submenu_class | prepend: ' class="' | append: '"' -%}
    {%- else -%}
        {%- assign submenu_class = "" -%}
    {%- endif -%}

    {%- assign anchor_class = "" -%}
    {%- if include.anchor_class -%}
        {%- assign anchor_class = include.anchor_class | prepend: ' class="' | append: '"' -%}
    {%- endif -%}

    {%- if include.html -%}
        {%- assign html_source = include.html -%}
    {%- else -%}
        {%- assign html_source = content -%}
    {%- endif -%}

    {%- assign headings = html_source | split: "<h" -%}

    {%- for heading in headings -%}
        {%- if heading == "" or heading == " " -%}
            {%- continue -%}
        {%- endif -%}

        {%- assign h_level = heading | slice: 0 | plus: 0 -%}
        {%- assign h_min = include.h_min | default: 1 -%}
        {%- assign h_max = include.h_max | default: 6 -%}

        {%- if h_level >= h_min and h_level <= h_max -%}
            {%- assign heading_id = heading | split: 'id="' -%}

            {%- if heading_id.size > 1 -%}
                {%- assign heading_id = heading_id[1] | split: '"' | first -%}
            {%- else -%}
                {%- if include.skip_no_ids == true -%}
                    {%- continue -%}
                {%- endif -%}

                {%- comment -%} =============================================== {%- endcomment -%}
                {%- comment -%} Fallback to find the heading's text as a backup {%- endcomment -%}
                {%- comment -%} =============================================== {%- endcomment -%}
                {%- assign heading_id = heading | split: "</h" | first | split: ">" | last -%}

                {%- if include.sanitize -%}
                    {%- assign heading_id = heading_id | strip_html -%}
                {%- endif -%}
            {%- endif -%}

            {%- assign heading_text = heading | split: '>' | slice: 1 | join: '>' | split: '</h' | first -%}
            {%- assign beginning_of_text = heading_text | slice: 0, 1 -%}

            {%- comment -%} ========================================================= {%- endcomment -%}
            {%- comment -%} Cleanup the heading text in case there are anchor clients {%- endcomment -%}
            {%- comment -%} ========================================================= {%- endcomment -}
            {%- if beginning_of_text == "<" -%}
                {%- assign heading_text = heading_text | split: '</a>' | last -%}
            {%- endif -%}

            {%- if include.sanitize -%}
                {%- assign heading_text = heading_text | strip_html | rstrip -%}
            {%- endif -%}

            {%- assign li_class = item_class | replace: '%level%', h_level -%}

            {%- comment -%}
                If the heading level is greater than the last one, start a new nested list.
            {%- endcomment -%}
            {%- if h_level > headline_last_level and include.flat_toc != true -%}
                {%- assign sub_class = submenu_class | replace: '%level%', h_level -%}
                {%- assign list_item = " " | prepend: "<li>" | prepend: list_type | prepend: sub_class | prepend: "<" | append: ">" -%}
                {%- assign headline_buffer = headline_buffer | append: list_item -%}
            {%- endif -%}

            {%- comment -%}
                If the heading level is less than the last one, close the current list and any other lists
                that are "deeper" than the current heading level.
            {%- endcomment -%}
            {%- if h_level < headline_last_level and include.flat_toc != true -%}
                {%- assign level_diff = headline_last_level | minus: h_level -%}

                {%- for i in (1..level_diff) -%}
                    {%- assign list_item = " " | prepend: "</li>" | prepend: list_type | prepend: "</" | append: ">" -%}
                    {%- assign headline_buffer = headline_buffer | append: list_item -%}
                {%- endfor -%}
            {%- endif -%}

            {%- assign href_base = "" -%}
            {%- if include.base_url -%}
                {%- assign href_base = include.base_url -%}
            {%- elsif page.url -%}
                {%- comment -%}
                    Only use `page.url` if the ToC is being displayed on a different
                    page than where the headers are.
                {%- endcomment -%}
                {%- unless page.content contains html_source -%}
                    {%- assign href_base = page.url | relative_url -%}
                {%- endunless -%}
            {%- endif -%}

            {%- assign slug = heading_text | slugify: "latin" -%}
            {%- assign href = heading_id | default: slug | prepend: '#' | prepend: href_base -%}

            {%- assign list_item = "<li" | append: li_class | append: '><a href="' | append: href | append: '"' | append: anchor_class | append: '>' | append: heading_text | append: "</a></li>" -%}

            {%- assign headline_buffer = headline_buffer | append: list_item -%}
            {%- assign headline_last_level = h_level -%}
        {%- endif -%}
    {%- endfor -%}

    {%- comment -%}
        Close any remaining open lists.
    {%- endcomment -%}
    {%- if headline_last_level > 0 and include.flat_toc != true -%}
        {%- for i in (1..headline_last_level) -%}
            {%- assign list_item = " " | prepend: "</li>" | prepend: list_type | prepend: "</" | append: ">" -%}
            {%- assign headline_buffer = headline_buffer | append: list_item -%}
        {%- endfor -%}
    {%- endif -%}

    {%- assign toc_class = "" -%}
    {%- if include.class -%}
        {%- assign toc_class = include.class | prepend: ' class="' | append: '"' -%}
    {%- endif -%}

    {%- assign toc_id = "" -%}
    {%- if include.id -%}
        {%- assign toc_id = include.id | prepend: ' id="' | append: '"' -%}
    {%- endif -%}

    {%- assign list_tag = "<" | append: list_type | append: toc_id | append: toc_class | append: ">" -%}
    {%- assign output = headline_buffer | size | minus: 1 | slice: headline_buffer, 1 -%}
    {%- assign output = list_tag | append: output -%}

    {{- output -}}
{%- endif -%} 